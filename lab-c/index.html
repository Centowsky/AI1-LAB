<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Maps with Leaflet</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>
    <style>
      #map {
        width: 600px;
        height: 300px;
        border: 1px solid black;
      }
      #rasterMap {
        width: 300px;
        height: 150px;
        border: 1px solid black;
      }

      .puzzle-board {
        width: 600px;
        height: 300px;
        background-color: #ccc;
        border: 2px solid #000;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(4, 1fr);
        gap: 2px;
        padding: 10px;
      }
      .main {
        display: flex;
        flex-direction: row;
        padding: 1rem;
      }

      .left {
        flex: 1;
      }

      .right {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(4, 150px); /* Adjust the size */
        grid-template-rows: repeat(4, 150px); /* Adjust the size */
        gap: 0;
      }

      .puzzleContainer {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
      }

      .puzzle-piece {
        display: inline-block;
        width: 75px;
        height: 75px;
        background-color: #fff;
        border: 1px solid #000;
      }

      .board-square {
        width: 125px; /* Adjust the size */
        height: 125px; /* Adjust the size */
        border: 1px solid #000;
        position: relative;
      }

      .board-square img {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div class="main">
      <div class="left">
        <div class="mapa">
          <div id="map"></div>
          <button id="getLocation">Get Current Location</button>
          <button id="saveButton">Save Raster Map</button>
        </div>
      </div>
      <div class="right"></div>
    </div>

    <div id="puzzleContainer"></div>

    <script>
      var map = L.map("map").setView([53.430127, 14.564802], 18);
      var puzzlePieces = [];

      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          attribution: "Tiles &copy; Esri",
        }
      ).addTo(map);

      var marker = L.marker([53.430127, 14.564802]).addTo(map);

      function drag(event) {
        event.dataTransfer.setData("text", event.target.id);
      }

      function allowDrop(event) {
        event.preventDefault();
      }

      function drop(event) {
        event.preventDefault();
        var data = event.dataTransfer.getData("text");
        var piece = document.getElementById(data);
        event.target.appendChild(piece);

        var boardSquares = document.querySelectorAll(".board-square");
        var puzzlePiecesInBoard =
          document.querySelectorAll(".board-square img");
        if (boardSquares.length === puzzlePiecesInBoard.length) {
          var isSolved = true;
          for (var i = 0; i < boardSquares.length; i++) {
            if (boardSquares[i].firstChild !== puzzlePiecesInBoard[i]) {
              isSolved = false;
              break;
            }
          }
          if (isSolved) {
            alert("Ułożono!");
          }
        }
      }

      document
        .getElementById("getLocation")
        .addEventListener("click", function () {
          if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(function (position) {
              var lat = position.coords.latitude;
              var lon = position.coords.longitude;
              var coords =
                "Latitude: " +
                lat.toFixed(6) +
                "<br>Longitude: " +
                lon.toFixed(6);
              marker.setLatLng([lat, lon]);
              marker
                .bindPopup("<strong>Your Location</strong><br>" + coords)
                .openPopup();
              map.setView([lat, lon], 18);
            });
          } else {
            alert("Geolocation is not available in your browser.");
          }
        });

      document
        .getElementById("saveButton")
        .addEventListener("click", function () {
          var puzzleContainer = document.getElementById("puzzleContainer");
          puzzleContainer.innerHTML = "";
          puzzlePieces = [];

          map.invalidateSize();
          leafletImage(map, function (err, canvas) {
            if (err) {
              console.error(err);
              return;
            }

            var pieceWidth = canvas.width / 4;
            var pieceHeight = canvas.height / 4;

            for (var row = 0; row < 4; row++) {
              for (var col = 0; col < 4; col++) {
                var puzzlePiece = document.createElement("div");
                puzzlePiece.className = "puzzle-piece";
                puzzlePiece.setAttribute("draggable", "true"); // Set draggable attribute
                puzzlePiece.ondragstart = function (event) {
                  drag(event);
                };
                puzzlePiece.style.width = pieceWidth + "px";
                puzzlePiece.style.height = pieceHeight + "px";

                var pieceCanvas = document.createElement("canvas");
                pieceCanvas.width = pieceWidth;
                pieceCanvas.height = pieceHeight;
                var ctx = pieceCanvas.getContext("2d");
                ctx.drawImage(
                  canvas,
                  -col * pieceWidth,
                  -row * pieceHeight,
                  canvas.width,
                  canvas.height
                );
                puzzlePiece.appendChild(pieceCanvas);
                puzzlePieces.push(puzzlePiece);
              }
            }

            puzzlePieces.sort(function () {
              return 0.5 - Math.random();
            });

            for (var i = 0; i < puzzlePieces.length; i++) {
              puzzleContainer.appendChild(puzzlePieces[i]);
            }
          });
        });
    </script>
  </body>
</html>
